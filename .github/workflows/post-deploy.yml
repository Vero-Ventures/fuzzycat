name: Post-Deploy Smoke Test

on:
  deployment_status:

permissions:
  contents: read
  deployments: read

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Production'
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 15

      - name: Check /api/health
        run: |
          url="https://fuzzycatapp.com"
          status=$(curl -sL -o /dev/null -w '%{http_code}' "${url}/api/health")
          echo "GET /api/health → HTTP $status"
          if [ "$status" -ne 200 ]; then
            echo "::error::Health check failed with HTTP $status"
            curl -sL "${url}/api/health" | head -c 500
            exit 1
          fi

      - name: Check / (landing page)
        run: |
          url="https://fuzzycatapp.com"
          status=$(curl -sL -o /dev/null -w '%{http_code}' "${url}/")
          echo "GET / → HTTP $status"
          if [ "$status" -ne 200 ]; then
            echo "::error::Landing page returned HTTP $status"
            exit 1
          fi

      - name: Verify security headers
        run: |
          url="https://fuzzycatapp.com"
          headers=$(curl -sI -L "$url")
          echo "$headers"
          failed=0
          for h in "strict-transport-security" "x-content-type-options" "x-frame-options" "referrer-policy" "permissions-policy"; do
            if echo "$headers" | grep -qi "^$h:"; then
              echo "✓ $h present"
            else
              echo "::error::Missing security header: $h"
              failed=1
            fi
          done
          if [ "$failed" -ne 0 ]; then
            exit 1
          fi
          echo "All required security headers present."
