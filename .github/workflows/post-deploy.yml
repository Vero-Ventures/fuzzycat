name: Post-Deploy Smoke Test

on:
  deployment_status:

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 15

      - name: Check /api/health
        run: |
          url="${{ github.event.deployment_status.target_url }}"
          status=$(curl -s -o /dev/null -w '%{http_code}' "${url}/api/health")
          echo "GET /api/health → HTTP $status"
          if [ "$status" -ne 200 ]; then
            echo "::error::Health check failed with HTTP $status"
            curl -s "${url}/api/health" | head -c 500
            exit 1
          fi

      - name: Check / (landing page)
        run: |
          url="${{ github.event.deployment_status.target_url }}"
          status=$(curl -s -o /dev/null -w '%{http_code}' "${url}/")
          echo "GET / → HTTP $status"
          if [ "$status" -ne 200 ]; then
            echo "::error::Landing page returned HTTP $status"
            exit 1
          fi
